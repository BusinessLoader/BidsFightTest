<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * data:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  
    <script src="components/loader.js"></script>
    <!--<script src="lib/onsenui/js/onsenui.min.js"></script>-->
    <script src="lib/onsenui/js/onsenui.js"></script>
    <link rel="stylesheet" href="components/loader.css">
    <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
  
    <script src="lib/jquery/jquery-3.1.1.min.js"></script>
  
    <link  href="lib/fancybox/jquery.fancybox.min.css" rel="stylesheet">
    <!--<script src="lib/fancybox/jquery.fancybox.min.js"></script>-->
    <script src="lib/fancybox/jquery.fancybox.js"></script><!-- в этом файле поправлена проблема с тем, что для видео и карт библиотека не подставляет переданный в урле протокол, а генерит урл без протокола, из-за чего в Кордове получается урл на локальные файлы на устройстве и, соответственно, ошибка. Нужно поправить и в минифицированной версии для продакшена. -->

    <link  href="lib/leaflet/leaflet.css" rel="stylesheet">
    <script src="lib/leaflet/leaflet.js"></script>
    <!--<script src="lib/leaflet/leaflet-src.js"></script>-->

    <link  href="lib/leaflet-awesome-markers/leaflet.awesome-markers.css" rel="stylesheet">
    <script src="lib/leaflet-awesome-markers/leaflet.awesome-markers.min.js"></script>

    <!--<link  href="lib/intro/introjs.min.css" rel="stylesheet">-->
    <!--<script src="lib/intro/intro.min.js"></script>-->

    <!--<link  href="lib/bootstrap-tour/bootstrap-tour-standalone.min.css" rel="stylesheet">-->
    <!--<script src="lib/bootstrap-tour/bootstrap-tour-standalone.min.js"></script>-->
    
    <!--<link rel="stylesheet" type="text/css" href="//oss.maxcdn.com/jquery.trip.js/3.3.3/trip.min.css"/>-->
    <!--<script src="//oss.maxcdn.com/jquery.trip.js/3.3.3/trip.min.js"></script>-->
    
    <link rel="stylesheet" type="text/css" href="lib/choices/choices.min.css"/>
    <style>
    .choices__list--multiple .choices__item {
        background-color: #d11;
        border: 1px solid #900;
        font-size: 15px;
    }
    
    .choices[data-type*=select-multiple] .choices__button, .choices[data-type*=text] .choices__button {
        border-left: 1px solid #fff;
    	opacity: 1;
    }    
    </style>
    <script src="lib/choices/choices.min.js"></script>

    <!--<link rel="stylesheet" type="text/css" href="lib/select2/select2.css"/>-->
    <!--<link rel="stylesheet" type="text/css" href="lib/select2/select2.min.css"/>-->
    <!--<script src="lib/select2/select2.full.min.js"></script>-->

    <link id="themeComponents" rel="stylesheet" href="css/theme-bidsfight.css" >
    <link rel="stylesheet" href="css/style-base.css">
    <link id="themeStyle" rel="stylesheet" href="css/style-bidsfight.css">
    
    <!--Animate.css содержит много анимаций и много весит. Только нужное вырезано и вставлено в файл animate-bidsfight.css-->
    <!--<link rel="stylesheet" href="css/animate.css">-->
    <link rel="stylesheet" href="css/animate-bidsfight.css">


  <script>
  
  var fullScreenFancyBox = false;
    ons.ready(onOnsReady); 
    function onOnsReady()
    {
        //alert('onOnsReady');
        
        if ( ons.isWebView() )
        {
            ons.setDefaultDeviceBackButtonListener(function()
                {
                    ons.notification.confirm('Do you want to close the app?', {cancelable:true, title:"Exit"}) // Ask for confirmation
                    .then(function(index)
                    {
                        if (index === 1) // OK button
                        {
                            navigator.app.exitApp(); // Close the app
                        }
                    });
            });
        }
    }

    document.addEventListener('preshow', onPreshowAlertDialog);        
    document.addEventListener('change', onChangeEvent); //если название функции onChange - то не срабатывает. Видимо, пересекается с каким-то стандартным обработчиком HTML       

    function onPreshowAlertDialog(event)
    {
        if ( event.target.matches('#dialogConnectionLost') )
        {
            document.getElementById('dontShowConnectionAlert').checked = !showConnectionAlert;
        }
    }
    
    function onChangeEvent(event)
    {
        //Событие приходит не только на событие смены ориентации, но и на изменение галочки чекбокса или других контролов, поскольку название события одинаковое. Нужно фильтровать по объекту.
        //alert("orientation changed: event.isPortrait = " + event.isPortrait + "  ons.orientation.isPortrait() = " + ons.orientation.isPortrait());
        //console.log("orientation changed: event.isPortrait = " + event.isPortrait + "  ons.orientation.isPortrait() = " + ons.orientation.isPortrait());
    }
    
    window.fn = {};
    
    window.fn.openMenuMain = function() {
      var menu = document.getElementById('menuMain');
      menu.open();
    };
    
    window.fn.load = function(page, options) {
      var menu = document.getElementById('menuMain');
      var navi = document.getElementById('navigator');
    
      menu.close();
      /*navi.resetToPage(page, { animation: 'fade' });*/
      navi.pushPage(page, options);
    };  
  
    document.addEventListener("deviceready", onDeviceReady, false);
    function onDeviceReady()
    {
        //alert('deviceready');
        
        document.addEventListener("offline", onOffline, false);
        document.addEventListener("online", onOnline, false);
        universalLinks.subscribe("openAuctionPageFromLink",onOpenAuctionPageFromLink);
        universalLinks.subscribe("launchedAppFromLink",onLaunchedAppFromLink);
        //universalLinks.subscribe("universallinks",onuniversallinks);

    }
    
    /*function onuniversallinks(eventData)
    {
        alert("onuniversallinks");
    }*/
    
    function onLaunchedAppFromLink(eventData)
    {
        //alert("onLaunchedAppFromLink");
    }
    
    function onOpenAuctionPageFromLink(eventData)
    {
        //alert("onOpenAuctionPageFromLink");
        if ( eventData.url.toLowerCase().indexOf("bidsfight.com/auction") == -1 )
            return;
        if ( !eventData.params.id )
            return;
        
        fn.load('Auction.html');
        
    }
    
    var connectionTimerId = -1;
    var showConnectionAlert = window.localStorage.getItem("showConnectionAlert");
    if ( showConnectionAlert == null )
    {
        showConnectionAlert = true;
    }
    else
    {
        showConnectionAlert = JSON.parse(showConnectionAlert);
    }
    //alert("start showConnectionAlert="+showConnectionAlert);
    var showConnectionRestored = false;
    
    //загрузка настройки темы пользователя
    //debugger;
    var themeName = window.localStorage.getItem("themeName");
    if ( themeName == null )
    {
        themeName = "themeDefault";
    }
    else
    {
        if ( themeName != "themeDark")
        {
            themeName = "themeDefault";
        }
    }
    setTheme();
    
    function setTheme()
    {
        //подключение темы
        if ( themeName == "themeDark")
        {
            document.getElementById("themeComponents").href = "css/theme-bidsfight-dark.css";
            document.getElementById("themeStyle").href = "css/style-bidsfight-dark.css";
        }
        else
        {
            document.getElementById("themeComponents").href = "css/theme-bidsfight.css";
            document.getElementById("themeStyle").href = "css/style-bidsfight.css";
        }
    }

    
    function connectionLost()
    {
        //Если объекста connection нет (такое случается в десктопных браузерах) - ничего не делаем
        if ( navigator.connection === undefined )
            return;
            
        //Если обрыв связи не восстановился - предупредить пользователя
        if ( navigator.connection.type == Connection.NONE )
        {
            //если активна опция показа предупреждения разрыва соединения - показать диалог с пиканьем и вибрацией
            if ( showConnectionAlert )
            {
                navigator.notification.beep(1);
                navigator.vibrate(1000);
                //ons.notification.alert({messageHTML:"<p>Internet connection is lost!</p>Please make sure that you can control your auctions in another way!", title:"ERROR", cancelable:true});
                showAlertDialog('dialogConnectionLost');
            }
            //иначе тихо показать всплывающий и исчезающий toast
            else
            {
                window.plugins.toast.showWithOptions({
                    message: "Internet connection is lost!",
                    duration: 5000, 
                    position: "bottom",
                    addPixelsY: -50,
                    styling:
                    {
                        opacity: 0.8, // 0.0 (transparent) to 1.0 (opaque). Default 0.8 
                        backgroundColor: '#dd8888', // make sure you use #RRGGBB. Default #333333 
                        textColor: '#333333', // Ditto. Default #FFFFFF 
                        textSize: 16, // Default is approx. 13. 
                        //cornerRadius: 16, // minimum is 0 (square). iOS default 20, Android default 100 
                        //horizontalPadding: 20, // iOS default 16, Android default 50 
                        //verticalPadding: 16 // iOS default 12, Android default 30 
                    }
                });            
            }
            
            //выставить флаг, что при восстановлении соединения необходимо показать toast
            showConnectionRestored = true;
        }
        
        connectionTimerId = -1;
    }

    function onOffline()
    {
        // Handle the offline event
        //подождать 30 секунд после разрыва связи, чтобы не долбить пользователя по случайным недолгим пропаданиям сотового сигнала 
        //иногда событие offline приходит два раза при одном обрыве (иногда сразу одно за одним), запускаются два таймера и потом показываются два диалога подряд
        //поэтому сначала проверяем, что таймер ещё не был запущен
        if ( connectionTimerId == -1 )
        {
            connectionTimerId = setTimeout(connectionLost,30000);
            //alert(connectionTimerId);
        }
    }        

    function onOnline()
    {
        // Handle the online event
        //Если обрыв связи быстро восстановился - отменить показ предупреждения о разрыве
        if ( connectionTimerId != -1 )
        {
            clearTimeout(connectionTimerId);
            connectionTimerId = -1;
        }
        //если обрыв был долгим и мы успели показать сообщение о потере связи, то показать всплывающее уведомление о восстановлении связи
        else if ( showConnectionRestored )
        {
            window.plugins.toast.showWithOptions({
                message: "Internet connection is restored",
                duration: 4000, 
                position: "bottom",
                addPixelsY: -50,
                styling:
                {
                    opacity: 0.8, // 0.0 (transparent) to 1.0 (opaque). Default 0.8 
                    backgroundColor: '#88dd88', // make sure you use #RRGGBB. Default #333333 
                    textColor: '#333333', // Ditto. Default #FFFFFF 
                    textSize: 16, // Default is approx. 13. 
                    //cornerRadius: 16, // minimum is 0 (square). iOS default 20, Android default 100 
                    //horizontalPadding: 20, // iOS default 16, Android default 50 
                    //verticalPadding: 16 // iOS default 12, Android default 30 
                }
            });
            
            showConnectionRestored = false;
        }
    }        

    function showAuctionInfo()
    {
        //if ( !event.target.matches('.ons-icon') && !(event.target.tagName == "A") )
        if ( !event.target.matches('.ons-icon') && !event.target.parentElement.classList.contains('phone') && !event.target.parentElement.classList.contains('location') )
        {
            //alert("Auction info");
            fn.load('Auction.html');
        }
    }
    
    // Page show event
    document.addEventListener('show', function(event)
    {
        var page = event.target;
            
        if (page.matches('#History'))
        {
            /*var intro = introJs();
            intro.setOptions({
                hidePrev : true,
                hideNext : true,
                showStepNumbers : false,
                showBullets : true,
                scrollToElement : true,
                tooltipPosition : 'bottom',
            });
            intro.start();*/
            
            // Instance the tour
            /*var tour = new Tour({
                //backdrop : true,
                //container : false,
              steps: [
              {
                element: "#buttonBack",
                title: "Back",
                content: "Back to previous page",
                placement: "auto",
                smartPlacement: false,
              },
              {
                element: "#buttonFilter",
                title: "Filter",
                content: "Filter history list",
                placement: "top",
                smartPlacement: false,
              }
            ]});
            // Initialize the tour
            tour.init();
            // Start the tour
            tour.start();*/
            
            /*var tripToHighlight = new Trip([
              { sel : $("#buttonBack"), content : "Button Back", expose : false, position: 's' }
            ], {
              delay : -1
            });
            tripToHighlight.start();*/
           
            //самодеятельность по onboarding-туру
            startTour();
            
        }
        
        
    });

    // Navigator prepush event
    document.addEventListener('prepush', function(event) {
      var page = event.target;
        
        //alert("prepush\r\n"+page); 
    });

    var choicesAuctionType;

    // Page init event
    document.addEventListener('init', function(event) {
        
        var page = event.target;

//console.log("init page.id = "+page.id);

        //для обработки нажатия кнопки Back на телефоне, нужно навесить хендлер, чтобы при необходимости закрывать не страницу, а открытую галерею или тур по продукту и т.д.
        //но хендлер нельзя навешивать на боковое выезжающее меню, иначе будут проблемы
        if (!page.matches('#menuMainSlide'))
        {
            page.onDeviceBackButton = function(event)
            {
                if ( fullScreenFancyBox )
                {
                    $.fancybox.close( true );
                    fullScreenFancyBox = false;
                }
                else if ( currentTourElem )
                {
                    tourStop();
                }
                else
                {
                    event.callParentHandler(); // Calls the parent handler (navigator handler in this case)
                }
            };            

        }
      
      if (page.matches('#Search'))
      {
        
        //KSV нужно раскомментарить, чтобы открывалась сразу нужная закладка (было убрано для экспериментов с тегами Choices)
        var index = page.data.activeTab ? page.data.activeTab : 0;
        var tabbar = document.getElementById('SearchTabbar');
        if( index != tabbar.tabIndex )
            tabbar.setActiveTab(index);
      }
      
      else if (page.matches('#SearchSimple'))
      {
          //debugger;
            choicesAuctionType = new Choices(document.getElementById('searchAuctionType'),{removeItemButton: true,});
            choicesAuctionType.setChoices(
            [
                {value: 'id1', label: 'Bar'},
                {value: 'id2', label: 'Night club'},
                {value: 'id3', label: 'Cafe'},
                {value: 'id4', label: 'Restaurant'},
            ],
            'value', 'label', true);
            /*$("#searchAuctionType").select2({
              tags: true
            });*/            
      }
      else if (page.matches('#SettingsNotifications'))
      {
            document.getElementById('showConnectionAlert').checked = showConnectionAlert;
      
      }
      else if (page.matches('#SettingsAppearance'))
      {
            document.getElementById(themeName).checked = true;
      }
      
    });
    
    /*ons.createPopover('menuMore.html');
    ons.createPopover('menuAuction.html');*/
    
    /*function showMenuAuction(target)
    {
        ons.createPopover('menuAuction.html').then(function(popover){popover.show(target);})
    }*/
    
    /*function showMenuMore(target)
    {
        ons.createPopover('menuMore.html').then(function(popover){popover.show(target);});
    }*/

    function showPopover(id, target)
    {
        var popover = document.getElementById(id);
        if ( popover )
        {
            popover.show(target);
        }
        else
        {
            ons.createPopover(id+'.html').then(function(popover){popover.show(target);});
        }
    }

    function scanBarcode( )
    {
        //window.plugins.barcodeScanner.scan(
        cordova.plugins.barcodeScanner.scan(
            function(result)
            {
                /*alert("We got a barcode!\n" +
                          "Result: " + result.text + "\n" +
                          "Format: " + result.format + "\n" +
                          "Cancelled: " + result.cancelled);*/
                          
                if ( result.cancelled )
                    return;
                
                var message;
                var error = false; 
                
                if ( result.format != 'QR_CODE' )
                {
                    //message = "Only the QR-Code is applicable.\r\nPlease use the correct QR-Code.";
                    message = "Only the QR-Code is applicable.<br/>Please use the correct QR-Code.";
                    error = true;
                }
                else if ( result.text.toLowerCase().indexOf("http://www.bidsfight.com/auction?id=") != 0 )
                {
                    //message = "QR-Code URL should be in form:\r\n\"http://www.bidsfight.com/auction?id=ХХХХХ\"\r\n where XXXXX should be auction ID number.\r\nPlease use proper QR-Code.";
                    message = 'QR-Code URL should be in form:<br><textarea style="width:90%">http://www.bidsfight.com/auction?id=ХХХХХ</textarea><br/>where XXXXX should be auction ID number.<br/>Please use proper QR-Code.';
                    error = true;
                }
                
                if ( error )
                {
                    var messageAsk = message + "<p>Scan again?</p>";
                    ons
                        //.notification.confirm(message+"\r\n"+"Scan again?", {buttonLabels:["Cancel", "Scan"], primaryButtonIndex:1, title:"Scan error", cancelable:true})
                        .notification.confirm({messageHTML:messageAsk, buttonLabels:["Cancel", "Scan"], primaryButtonIndex:1, title:"Scan error", cancelable:true})
                        .then(function(button)
                        {
                            if ( button == 1 )
                            {
                                //alert("Rescan!");
                                scanBarcode();
                            }
                        });
                    return;
                }
                
                navigator.notification.beep(1);
                navigator.vibrate(1000);
                fn.load('Auction.html');
                /*alert("We got a barcode!\n" +
                          "Result: " + result.text + "\n" +
                          "Format: " + result.format + "\n" +
                          "Cancelled: " + result.cancelled);*/
                          
                
            },
            function(error) {
                alert("Scanning failed: " + error);
            },
            {//параметры не работают с плагином cordova-plugin-barcodescanner (он же стандартный плагин Monaca). Параметры есть в phonegap-plugin-barcodescanner (Чтобы его импортировать в проект - нужен платный тарив в Monaca)
                preferFrontCamera : false, // iOS and Android
                showFlipCameraButton : true, // iOS and Android
                showTorchButton : true, // iOS and Android
                torchOn: false, // Android, launch with the torch switched on (if available)
                prompt : "Place a barcode inside the scan area", // Android
                resultDisplayDuration: 0, // Android, display scanned text for X ms. 0 suppresses it entirely, default 1500
                formats : "QR_CODE", // default: all but PDF_417 and RSS_EXPANDED
                //orientation : "portrait", // Android only (portrait|landscape), default unset so it rotates with the device
                disableAnimations : true // iOS
            }            
        );

    }
    
    var showAlertDialog = function(id) {
      /*document
        .getElementById(id)
        .show();*/
        
        var dialog = document.getElementById(id);
        
        if (dialog)
        {
            dialog.show();
        }
        else
        {
            ons
            .createAlertDialog(id+'.html')
            .then
            (
                function(dialog)
                {
                    dialog.show();
                }
            );
        }
    };
    
    var hideDialog = function(id) {
      document
        .getElementById(id)
        .hide();
    };

    function ClearHistory()
    {
        showAlertDialog('dialogConfirmClearHistory');        
    }

    function FilterHistory()
    {
        showAlertDialog('dialogFilterHistory');
    }

    function MakeBid()
    {
        showAlertDialog('dialogMakeBid');
    }


    
    function showFancyBox(auctionId, animationElem)
    {
        var options = 
        {
            speed : 0,//выключаем постепенное появление на экране и исчезание (мешает в комбинации с анимацией разворачивания элемента)
            loop : true,
            closeClickOutside : false,
            thumbs : {
            showOnStart   : true, // Display thumbnails on opening
            hideOnClosing : true   // Hide thumbnail grid when closing animation starts
            }                
        };
        
        var images;
        if ( auctionId == 1 )
        {
            images = 
            [
                {
                	src  : 'images/eiffel1.jpg',
            		opts : {
            			caption : 'First caption'
            		}
            	},
                {
                    src  : 'https://www.youtube.com/watch?v=MMn0AollE5I&t=41',
            		opts : {
            			caption : 'YouTube video'
            		}
            	},
            	{
            		src  : 'images/eiffel2.jpg',
            		opts : {
            			caption : 'Second caption'
            		}
            	},
                {
            		src  : 'images/eiffel3.jpg',
            		opts : {
            			caption : 'Next caption'
            		}
            	},
                {
            		src  : 'images/eiffel4.jpg',
            		opts : {
            			caption : 'Other caption'
            		}
            	},
                {
                	src  : 'https://www.google.ru/maps/@48.8581206,2.2945218,16z',
            		opts : {
            			caption : 'Google Map'
            		}
            	}
            ];
        }
        else if ( auctionId == 2 )
        {
            images = 
            [
                {
                    src  : 'images/monumentvalley1.jpg',
            		opts : {
            			caption : 'First caption'
            		}
            	},
            	{
            		src  : 'images/monumentvalley2.jpg',
            		opts : {
            			caption : 'Second caption'
            		}
            	},
                {
            		src  : 'images/monumentvalley3.jpg',
            		opts : {
            			caption : 'Next caption'
            		}
            	},
                {
            		src  : 'images/monumentvalley4.jpg',
            		opts : {
            			caption : 'Other caption'
            		}
            	}
            ];
        }
        else if ( auctionId == 3 )
        {
            images = 
            [
                {
                    src  : 'images/mountfuji1.jpg',
                	opts : {
            			caption : 'First caption'
            		}
            	},
            	{
            		src  : 'images/mountfuji2.jpg',
            		opts : {
            			caption : 'Second caption'
            		}
            	},
                {
            		src  : 'images/mountfuji3.jpg',
            		opts : {
            			caption : 'Next caption'
            		}
            	},
                {
            		src  : 'images/mountfuji4.jpg',
            		opts : {
            			caption : 'Other caption'
            		}
            	}
            ];
        }
        else if ( auctionId == 4 )
        {
            images = 
            [
                {
                    src  : 'images/tokyotower1.jpg',
                	opts : {
            			caption : 'First caption'
            		}
            	},
            	{
            		src  : 'images/tokyotower2.jpg',
            		opts : {
            			caption : 'Second caption'
            		}
            	},
                {
            		src  : 'images/tokyotower3.jpg',
            		opts : {
            			caption : 'Next caption'
            		}
            	},
                {
            		src  : 'images/tokyotower4.jpg',
            		opts : {
            			caption : 'Other caption'
            		}
            	}
            ];
        }
        
        if ( animationElem )
        {
            var rect = animationElem.getBoundingClientRect();
            $(".fancyboxAnimator").css({"opacity":"0.2", "top":rect.top, "bottom":document.documentElement.clientHeight-rect.bottom, "left":rect.left, "right":document.documentElement.clientWidth-rect.right});
            $(".fancyboxAnimator").css({"display":"block"});
            
            //$(".fancyboxAnimator").animate({"opacity":"0.87", "top":"0", "bottom":"0", "left":"0", "right":"0"}, {duration:"500", easing:"linear", queue:false, complete:function(){$('.fancyboxAnimator').css({'display':'none'});}} );
            //setTimeout(function(){$.fancybox.open(images, options);}, 400);
            $(".fancyboxAnimator").animate({opacity:"0.87", top:"0", bottom:"0", left:"0", right:"0"}, {duration:300, easing:"linear", queue:false, complete:function(){$.fancybox.open(images, options); setTimeout(function(){$('.fancyboxAnimator').css({'display':'none'})}, 100)  }} );
        }
        else
        {
            $.fancybox.open(images, options);
        }
        
        /*$.fancybox.open(
        [
            {
        		src  : 'images/eiffel1.jpg',
        		opts : {
        			caption : 'First caption'
        		}
        	},
        	{
        		src  : 'images/eiffel2.jpg',
        		opts : {
        			caption : 'Second caption'
        		}
        	},
            {
        		src  : 'images/eiffel3.jpg',
        		opts : {
        			caption : 'Next caption'
        		}
        	},
            {
        		src  : 'images/eiffel4.jpg',
        		opts : {
        			caption : 'Other caption'
        		}
        	}
        ],
        {
        	loop : true,
            thumbs : {
            showOnStart   : true, // Display thumbnails on opening
            hideOnClosing : true   // Hide thumbnail grid when closing animation starts
            }                
        }
        );*/
        
        fullScreenFancyBox = true;
    }
    
    //событие открытия FancyBox, чтобы обрабатывать кнопку Back на устройстве для закрытия галереи
    $(document).on('onInit.fb', function( e, instance, slide ) {
        fullScreenFancyBox = true;
    });
    
    //событие закрытия FancyBox, чтобы не обрабатывать для галереи кнопку Back на устройстве
    $(document).on('afterClose.fb', function( e, instance, slide ) {
        fullScreenFancyBox = false;
    });


    function showBidPanel( button, showPanel )
    {
        var card = $(button).parents(".card");
        if ( !card )
            return;
        
        var colMakeBid = $(card).find(".colMakeBid");
        var colSpace = $(card).find(".colSpace");
        var colWinNow = $(card).find(".colWinNow");
        var bidPanel = $(card).find(".bidPanel");
        
        if( showPanel )
        {
            //document.getElementById('colMakeBid').style.maxWidth='47%';document.getElementById('colMakeBid').style.flexBasis='47%';document.getElementById('colSpace').style.maxWidth='6%';document.getElementById('colSpace').style.flexBasis='6%';document.getElementById('colWinNow').style.maxWidth='47%';document.getElementById('colWinNow').style.flexBasis='47%';document.getElementById('bidPanel').style.maxHeight=document.getElementById('bidPanel').scrollHeight+'px';document.getElementById('bidPanel').style.top='0px';
            $(colMakeBid).css({"maxWidth":"47%","flexBasis":"47%"});
            $(colSpace).css({"maxWidth":"6%","flexBasis":"6%"})
            $(colWinNow).css({"maxWidth":"47%","flexBasis":"47%"});
            var h = bidPanel.prop("scrollHeight")+"px";
            $(bidPanel).css({"maxHeight":h,"top":"0px"});
        }
        else
        {
            //document.getElementById('colMakeBid').style.maxWidth='100%';document.getElementById('colMakeBid').style.flexBasis='100%';document.getElementById('colSpace').style.maxWidth='0%';document.getElementById('colSpace').style.flexBasis='0%';document.getElementById('colWinNow').style.maxWidth='0%';document.getElementById('colWinNow').style.flexBasis='0%';document.getElementById('bidPanel').style.maxHeight='0px';document.getElementById('bidPanel').style.top='-60px'
            $(colMakeBid).css({"maxWidth":"100%","flexBasis":"100%"});
            $(colSpace).css({"maxWidth":"0%","flexBasis":"0%"})
            $(colWinNow).css({"maxWidth":"0%","flexBasis":"0%"});
            $(bidPanel).css({"maxHeight":"0px","top":"-60px"});
        }
    }

    
    var mapSearchAdvanced;
    var layerCircles;
    var layerMarkers;
    var markerPosition;
    var latitude = 0;
    var longitude = 0;
    var radarDiameter = 0;
    var searchRadius = 1000;
    var searchCircle;
    var boundsCircle;
    
    function positionDetected(position)
    {
        latitude=position.coords.latitude;
        longitude=position.coords.longitude;
        mapSearchAdvanced.setView([latitude, longitude], 13);
        
        if( !markerPosition )
        {
            var manMarker = L.AwesomeMarkers.icon({
            icon: 'street-view',
            markerColor: 'orange',
            iconColor: 'black',
            prefix:"fa"
            });
            
            markerPosition = L.marker([latitude, longitude], {icon: manMarker});            
            markerPosition.addTo(mapSearchAdvanced);            
        }
        else
        {
            markerPosition.setLatLng([latitude, longitude]);            
        }
        
    }
    
    function positionError(error)
    {
        alert('ERROR!' + '\r\n\r\n'  + 'Sorry, we can\'t detect your location. Please switch on geolocation services.' + '\r\n\r\n' + 'Error message: ' + error.message + '\r\n' + 'Error code: ' + error.code);
    }
    function clickNearMe(checkbox)
    {
        if ( !checkbox.checked )
        {
            $(".search-map-container").css("display", "none");
        }
        else
        {
            $("#search-map").css("height", "0px");
            $(".search-map-container").css("display", "block");
            var h = document.body.clientHeight - document.getElementById("search-advanced-button").getBoundingClientRect().bottom - 20;
            $("#search-map").css("height", h+"px");
            if( !mapSearchAdvanced )
            {
                mapSearchAdvanced = L.map('search-map',{zoomSnap:0});
            }
            
            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapSearchAdvanced);
            
            navigator.geolocation.getCurrentPosition(positionDetected, positionError,{ maximumAge: 60000, timeout: 5000, enableHighAccuracy: true });
        }
        
    }
    
    function searchAdvanced()
    {
        if( mapSearchAdvanced )
        {
            searchRadius = $("#search-distance")[0].value;
            
            //если нет группы, в которой хранятся круги поиска, то создать
            if( !layerCircles )
            {
                layerCircles = L.layerGroup();
                layerCircles.addTo(mapSearchAdvanced);
            }
            //если группа есть, то очистить предыдущие круги
            else
            {
                layerCircles.clearLayers();
            }
            
            //если нет группы, в которой хранятся метки результатов, то создать
            if( !layerMarkers )
            {
                layerMarkers = L.layerGroup();
                layerMarkers.addTo(mapSearchAdvanced);
            }
            //если группа есть, то очистить предыдущие маркеры
            else
            {
                layerMarkers.clearLayers();
            }
            
            
            //круг поиска на карте
            searchCircle = L.circle([window.latitude, window.longitude],{
                color: '#0b3',
                weight: 1,
                fillColor: '#0b3',
                fillOpacity: 0.2,
                radius: searchRadius
            });//.addTo(mapSearchAdvanced);
            layerCircles.addLayer(searchCircle);
            
            //круг чуть большего размера, чтобы установить размер карты (чтобы вписался круг поиска с зазором)
            boundsCircle = L.circle([window.latitude, window.longitude],{
                color: '0b3',
                weight: 0,
                fillColor: '#0b3',
                fillOpacity: 0,
                radius: searchRadius*1.2
            });//.addTo(mapSearchAdvanced);
            layerCircles.addLayer(boundsCircle);
            
            //устанавливаем центр карты в нашу позицию и устанавливаем масштаб карты чуть больше, чем круг поиска
            mapSearchAdvanced.setView([latitude, longitude], mapSearchAdvanced.getZoom());//используем текущий зум, чтобы не мигать перерисовкой карты, если пользователь менял зум от первоначального (тем более, что дальше зум опять изменится из-за вписывания в карту круга поиска)
            mapSearchAdvanced.fitBounds(boundsCircle.getBounds());
            
            
            //вычисляем размер и позицию радара, чтобы анимация оказалась в центре карты и нужного радиуса
            
            //этот вариант вычисляет размер неправильно, видимо, из-за масштабирования страницы в браузере.
            /*
            var pointLeftTop = mapSearchAdvanced.latLngToLayerPoint(searchCircle.getBounds().getNorthWest());
            var pointLeftBottom = mapSearchAdvanced.latLngToLayerPoint(searchCircle.getBounds().getSouthWest());
            var radarDiameter = pointLeftBottom.y - pointLeftTop.y;
            */
            
            radarDiameter = Math.min($("#search-map").width(),$("#search-map").height()) * 0.83333333; //коэффициент 0.833333 потому что размер карты 1.2 от круга поиска

            $("#radar").width(radarDiameter+"px");
            $("#radar").height(radarDiameter+"px");

            //включаем радар
            $("#radar").addClass("radar");
            
            //KSV временная заглушка для прототипа - отображение маркеров и выключению радара. В реальности должно происходить по окончании поиска. Если результаты приходят пачками - то отображать на карте по мере поступления. Ещё круче - ждать отображения нового результата пока не окажется на одной линии с лучом радара.
            setTimeout(showResult, 1200, "1");
            setTimeout(showResult, 2000, "2");
            setTimeout(showResult, 3400, "3");
            setTimeout(showResult, 5750, "4");
            setTimeout(stopRadar, 6000);
        }
        
    }
    
    function stopRadar()
    {
        //выключаем радар
        $("#radar").removeClass("radar");
        
        //ещё можно убрать с карты окружность, но лучше оставить, чтобы пользователь видел, в каких границах был поиск (особенно, если начнет зумить)
        //layerCircles.clearLayers();
        searchCircle.setStyle({fillOpacity : 0, color: '#d11', weight: 2});
    }
    
    function showResult( i )
    {
        var bounds;
        var markerResult;
        
        if ( i == 1 )
        {
            bounds = markerPosition.getLatLng().toBounds(searchRadius);
            markerResult = L.AwesomeMarkers.icon({
            icon: 'cutlery',
            markerColor: 'red',
            iconColor: 'white',
            prefix:"fa"
            });
            
            markerResult = L.marker(bounds.getSouthEast(), {icon: markerResult});
            markerResult.bindPopup('<b>Short auction description...</b><br>Time to left...<br>Current bid...<br><a href="#" onclick="showAuctionInfo()">More info...</a>');
            layerMarkers.addLayer(markerResult);            
        }
        else if ( i == 2 )
        {
            bounds = markerPosition.getLatLng().toBounds(searchRadius*1.3);
            markerResult = L.AwesomeMarkers.icon({
            icon: 'glass',
            markerColor: 'red',
            iconColor: 'white',
            prefix:"fa"
            });
            
            markerResult = L.marker(bounds.getSouthWest(), {icon: markerResult});            
            markerResult.bindPopup('<b>Short auction description...</b><br>Time to left...<br>Current bid...<br><a href="#" onclick="showAuctionInfo()">More info...</a>');
            layerMarkers.addLayer(markerResult);            
        }
        else if ( i == 3 )
        {
            bounds = markerPosition.getLatLng().toBounds(searchRadius*0.6);
            markerResult = L.AwesomeMarkers.icon({
            icon: 'coffee',
            markerColor: 'red',
            iconColor: 'white',
            prefix:"fa"
            });
            
            markerResult = L.marker(bounds.getNorthEast(), {icon: markerResult});            
            markerResult.bindPopup('<b>Short auction description...</b><br>Time to left...<br>Current bid...<br><a href="#" onclick="showAuctionInfo()">More info...</a>');
            layerMarkers.addLayer(markerResult);            
        }
        else if ( i == 4 )
        {
            bounds = markerPosition.getLatLng().toBounds(searchRadius*0.8);
            markerResult = L.AwesomeMarkers.icon({
            icon: 'cutlery',
            markerColor: 'red',
            iconColor: 'white',
            prefix:"fa"
            });
            
            markerResult = L.marker(bounds.getNorthWest(), {icon: markerResult});            
            markerResult.bindPopup('<b>Short auction description...</b><br>Time to left...<br>Current bid...<br><a href="#" onclick="showAuctionInfo()">More info...</a>');
            layerMarkers.addLayer(markerResult);            
        }
    }
  </script>
</head>
<body>

<ons-splitter>
  <ons-splitter-side id="menuMain" page="menuMainSlide.html" side="left" width="250px" swipe-target-width="100px" collapse swipeable>
  </ons-splitter-side>
  <ons-splitter-content>
    <ons-navigator id="navigator" page="Home.html" animation="slide"></ons-navigator>
  </ons-splitter-content>
</ons-splitter>

<!-- div для анимации разворачивания галереии FancyBox из картинки -->
<div class="fancyboxAnimator" style="position:fixed; display:none; background-color:black; opacity:0.4" ></div>


<!-- BEGIN блок самодеятельности для onboarding-тура по продукту, поскольку типовые библиотеки работают криво с OnsenUI -->
<div class="tourOverlay tourOverlayLeft" style="position:fixed; display:none; background-color:rgba(0,0,0,0.6)" ></div>
<div class="tourOverlay tourOverlayTop" style="position:fixed; display:none; background-color:rgba(0,0,0,0.6)" ></div>
<div class="tourOverlay tourOverlayRight" style="position:fixed; display:none; background-color:rgba(0,0,0,0.6)" ></div>
<div class="tourOverlay tourOverlayBottom" style="position:fixed; display:none; background-color:rgba(0,0,0,0.6)" ></div>

<ons-template id="popoverTour.html">
    <ons-popover direction="down" id="popoverTour" disable-auto-styling>
      <div style="padding: 10px; text-align: center;">
        <p id="tourCaption" style="font-weight:800">
          Caption
        </p>
        <p id="tourContent">
          Content
        </p>
        <p>
          <ons-button id="buttonTourNext" onclick="">Got it</ons-button>
        </p>
      </div>
    </ons-popover>
</ons-template>


<script>
    //фишка, предложенная Fran-Diox для лечения проблемы, при которой создание поповера без отображения на экране приводит к проблемам с кнопкой Back на телефоне
    function popoverBackHandler(e)
    {
        //к сожалению, фишка не работает, потому что в этом случае попап, не имеющий атрибута cancelable, вместо хендлеров страницы и навигатора сразу вызывает хендлер приложения, который должен закрыть приложение
        //var popover = document.getElementById('popoverTour');
        //popover.cancelable && popover.visible ? popover._cancel() : e.callParentHandler();
        
        //поэтому используем другую фишку собственного приготовления - при создании попапа делаем ему hide(), что почему-то сбрасывает хендлер
        
        //останавливаем показ, если он идёт
        if ( currentTourElem )
        {
            tourStop();
        }
    }
    
    //при создании попапа делаем ему hide(), что почему-то сбрасывает хендлер
    ons.createPopover('popoverTour.html').then(function(popover) {popover.onDeviceBackButton = popoverBackHandler; popover.hide();});

    var currentTourElem;
    
    function startTour()
    {
        //document.getElementById("buttonTourNext").onclick = tourStop;
        document.getElementById("buttonTourNext").onclick = function(){tourStop();showElementTour("historySearch", "Search", "You can use search in history list.");document.getElementById("buttonTourNext").onclick = function(){tourStop()}};
        showElementTour("historyFilter", "Filter", "You can use several condition to filter history list.");
    }
    
    function showElementTour(elemId, caption, content)
    {
        currentTourElem = document.getElementById(elemId);
        var rect = currentTourElem.getBoundingClientRect();
        $(".tourOverlayLeft").css({"top":"0", "bottom":"0", "left":"0", "right":document.documentElement.clientWidth-rect.left+"px"});
        $(".tourOverlayTop").css({"top":"0", "bottom":document.documentElement.clientHeight-rect.top+"px", "left":rect.left+"px", "right":document.documentElement.clientWidth-rect.right+"px"});
        $(".tourOverlayRight").css({"top":"0", "bottom":"0", "left":rect.right+"px", "right":"0"});
        $(".tourOverlayBottom").css({"top":rect.bottom+"px", "bottom":"0", "left":rect.left+"px", "right":document.documentElement.clientWidth-rect.right+"px"});
        $(".tourOverlay").css({"display":"block"});
        $(currentTourElem).addClass("animated infinite pulse-with-shadow");
        document.getElementById('tourCaption').innerHTML = caption;
        document.getElementById('tourContent').innerHTML = content;
        document.getElementById('popoverTour').show(currentTourElem);
    
    }
    
    function tourNext()
    {
        
    }
    
    function tourStop()
    {
        document.getElementById('popoverTour').hide();
        $('.tourOverlay').css({'display':'none'});
        $(currentTourElem).removeClass('animated infinite pulse-with-shadow');
        currentTourElem = null;
    }
</script>
<!-- END блок самодеятельности для onboarding-тура по продукту -->

</body>
</html>
